{"version":3,"file":"scene-graph-spec.js","sourceRoot":"","sources":["../../../src/test/features/scene-graph-spec.ts"],"names":[],"mappings":"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","sourcesContent":["/* @license\n * Copyright 2020 Google LLC. All Rights Reserved.\n * Licensed under the Apache License, Version 2.0 (the 'License');\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an 'AS IS' BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Mesh, MeshStandardMaterial} from 'three';\n\nimport {SceneGraphInterface, SceneGraphMixin} from '../../features/scene-graph.js';\nimport ModelViewerElementBase, {$scene} from '../../model-viewer-base.js';\nimport {waitForEvent} from '../../utilities.js';\nimport {assetPath, rafPasses} from '../helpers.js';\nimport {BasicSpecTemplate} from '../templates.js';\n\nconst expect = chai.expect;\n\nconst ASTRONAUT_GLB_PATH = assetPath('models/Astronaut.glb');\nconst HORSE_GLB_PATH = assetPath('models/Horse.glb');\nconst SUNRISE_IMG_PATH = assetPath('environments/spruit_sunrise_1k_LDR.jpg');\n\nsuite('ModelViewerElementBase with SceneGraphMixin', () => {\n  let nextId = 0;\n  let tagName: string;\n  let ModelViewerElement:\n      Constructor<ModelViewerElementBase&SceneGraphInterface>;\n  let element: InstanceType<typeof ModelViewerElement>;\n\n  setup(() => {\n    tagName = `model-viewer-scene-graph-${nextId++}`;\n    ModelViewerElement = class extends SceneGraphMixin\n    (ModelViewerElementBase) {\n      static get is() {\n        return tagName;\n      }\n    };\n    customElements.define(tagName, ModelViewerElement);\n\n    element = new ModelViewerElement();\n    document.body.insertBefore(element, document.body.firstChild);\n  });\n\n  teardown(() => {\n    document.body.removeChild(element);\n  });\n\n  BasicSpecTemplate(() => ModelViewerElement, () => tagName);\n\n  suite('scene export', () => {\n    suite('with a loaded model', () => {\n      setup(async () => {\n        element.src = ASTRONAUT_GLB_PATH;\n\n        await waitForEvent(element, 'load');\n        await rafPasses();\n      });\n\n      test('exports the loaded model to GLTF', async () => {\n        const exported = await element.exportScene({binary: false});\n        expect(exported).to.be.not.undefined;\n        expect(exported.size).to.be.greaterThan(500);\n      });\n\n      test('exports the loaded model to GLB', async () => {\n        const exported = await element.exportScene({binary: true});\n        expect(exported).to.be.not.undefined;\n        expect(exported.size).to.be.greaterThan(500);\n      });\n    });\n  });\n\n  suite('with a loaded scene graph', () => {\n    let material: MeshStandardMaterial;\n\n    setup(async () => {\n      element.src = ASTRONAUT_GLB_PATH;\n\n      await waitForEvent(element, 'scene-graph-ready');\n\n      material =\n          (element[$scene].modelContainer.children[0].children[0].children[0] as\n           Mesh)\n              .material as MeshStandardMaterial;\n    });\n\n    test('allows the scene graph to be manipulated', async () => {\n      await element.model!.materials[0].pbrMetallicRoughness.setBaseColorFactor(\n          [1, 0, 0, 1]);\n\n      expect(material.color).to.include({r: 1, g: 0, b: 0});\n\n      const color =\n          element.model!.materials[0].pbrMetallicRoughness.baseColorFactor;\n\n      expect(color).to.be.eql([1, 0, 0, 1]);\n    });\n\n    test('image.setURI sets the appropriate texture', async () => {\n      await element.model!.materials[0]\n          .pbrMetallicRoughness.baseColorTexture!.texture!.source!.setURI(\n              SUNRISE_IMG_PATH);\n\n      const uri =\n          element.model!.materials[0]\n              .pbrMetallicRoughness.baseColorTexture!.texture!.source!.uri;\n\n      expect(uri).to.be.eql(SUNRISE_IMG_PATH);\n    });\n\n    suite('when the model changes', () => {\n      test('updates when the model changes', async () => {\n        const color =\n            element.model!.materials[0].pbrMetallicRoughness.baseColorFactor;\n\n        expect(color).to.be.eql([0.5, 0.5, 0.5, 1]);\n\n        element.src = HORSE_GLB_PATH;\n\n        await waitForEvent(element, 'scene-graph-ready');\n\n        const nextColor =\n            element.model!.materials[0].pbrMetallicRoughness.baseColorFactor;\n\n        expect(nextColor).to.be.eql([1, 1, 1, 1]);\n      });\n\n      test('allows the scene graph to be manipulated', async () => {\n        element.src = HORSE_GLB_PATH;\n\n        await waitForEvent(element, 'scene-graph-ready');\n\n        await element.model!.materials[0]\n            .pbrMetallicRoughness.setBaseColorFactor([1, 0, 0, 1]);\n\n        const color =\n            element.model!.materials[0].pbrMetallicRoughness.baseColorFactor;\n\n        expect(color).to.be.eql([1, 0, 0, 1]);\n\n        const newMaterial =\n            (element[$scene].modelContainer.children[0].children[0] as Mesh)\n                .material as MeshStandardMaterial;\n\n        expect(newMaterial.color).to.include({r: 1, g: 0, b: 0});\n      });\n    });\n  });\n});\n"]}